<!DOCTYPE html>
<html lang="pt-BR">
<head>
    <meta charset="UTF-8">
    <title>Gabriel's Code Forge (Enhanced)</title>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <style>
        :root {
            --bg-dark: #1e1e1e;
            --bg-panel: #252526;
            --bg-input: #3c3c3c;
            --border: #333;
            --accent: #0e639c;
            --accent-hover: #1177bb;
            --text: #d4d4d4;
            --success: #2da042;
            --error: #f48771;
        }
        
        body { margin: 0; padding: 0; display: flex; height: 100vh; background: var(--bg-dark); color: var(--text); font-family: 'Segoe UI', sans-serif; overflow: hidden; }
        
        /* Layout */
        #sidebar { width: 400px; background: var(--bg-panel); border-right: 1px solid var(--border); display: flex; flex-direction: column; z-index: 10; }
        #main-content { flex: 1; display: flex; flex-direction: column; min-width: 0; }
        
        /* Sidebar Components */
        .header { padding: 15px; background: #333; font-weight: bold; border-bottom: 1px solid var(--bg-dark); display: flex; justify-content: space-between; align-items: center; }
        .status-dot { height: 10px; width: 10px; background-color: #555; border-radius: 50%; display: inline-block; transition: background 0.3s; }
        .status-online { background-color: #4caf50; box-shadow: 0 0 8px #4caf50; }
        
        .config-area { padding: 10px; background: #2d2d2d; border-bottom: 1px solid #444; }
        .input-group { display: flex; gap: 5px; }
        .config-area input { flex: 1; padding: 6px; background: var(--bg-input); border: 1px solid #555; color: white; border-radius: 4px; font-family: monospace; font-size: 12px; }
        .icon-btn { background: none; border: none; color: #ccc; cursor: pointer; padding: 5px; }
        .icon-btn:hover { color: white; }

        #chat-history { flex: 1; overflow-y: auto; padding: 15px; display: flex; flex-direction: column; gap: 15px; scroll-behavior: smooth; }
        
        /* Chat Messages */
        .message { padding: 12px; border-radius: 8px; max-width: 90%; font-size: 13px; line-height: 1.5; word-wrap: break-word; }
        .user { background: var(--accent); align-self: flex-end; color: white; border-bottom-right-radius: 2px; }
        .bot { background: var(--bg-input); align-self: flex-start; border: 1px solid #444; border-bottom-left-radius: 2px; }
        
        /* Markdown Styles within Bot Message */
        .bot pre { background: #1e1e1e; padding: 10px; border-radius: 4px; overflow-x: auto; border: 1px solid #555; margin: 5px 0; }
        .bot code { font-family: 'Consolas', monospace; color: #9cdcfe; font-size: 12px; }
        .bot p { margin: 5px 0; }
        .bot ul { padding-left: 20px; margin: 5px 0; }

        .apply-btn {
            display: inline-block;
            margin-top: 5px;
            background: var(--success);
            color: white;
            border: none;
            padding: 4px 8px;
            border-radius: 3px;
            cursor: pointer;
            font-size: 11px;
            font-weight: bold;
            text-transform: uppercase;
        }
        .apply-btn:hover { background: #238636; }

        /* Input Area */
        .input-area { padding: 15px; background: var(--bg-panel); border-top: 1px solid var(--border); }
        textarea { width: 100%; height: 60px; background: var(--bg-input); border: 1px solid #555; color: white; border-radius: 4px; resize: none; padding: 10px; box-sizing: border-box; font-family: sans-serif; }
        textarea:focus { outline: 1px solid var(--accent); }
        
        #sendBtn { margin-top: 8px; width: 100%; padding: 8px; background: var(--accent); color: white; border: none; cursor: pointer; border-radius: 4px; font-weight: bold; }
        #sendBtn:hover { background: var(--accent-hover); }
        #sendBtn:disabled { background: #555; cursor: wait; }

        /* Editor Area */
        .editor-toolbar { height: 40px; background: #2d2d2d; display: flex; align-items: center; padding: 0 10px; border-bottom: 1px solid var(--bg-dark); justify-content: space-between; }
        .toolbar-group { display: flex; gap: 10px; align-items: center; }
        .filename { font-size: 13px; color: #ccc; }
        
        .run-btn { background: var(--success); color: white; border: none; padding: 6px 12px; border-radius: 3px; cursor: pointer; font-size: 12px; display: flex; align-items: center; gap: 5px; }
        .run-btn:hover { background: #238636; }
        .run-btn i { font-size: 10px; }
        
        #editor-wrapper { flex: 1; position: relative; display: flex; flex-direction: column; }
        #monaco-container { flex: 1; min-height: 0; }
        
        /* Output Console */
        #console-panel { height: 150px; background: #1e1e1e; border-top: 1px solid var(--border); display: flex; flex-direction: column; transition: height 0.2s; }
        .console-header { padding: 5px 10px; background: #252526; font-size: 11px; font-weight: bold; text-transform: uppercase; letter-spacing: 0.5px; border-bottom: 1px solid #333; display: flex; justify-content: space-between; cursor: ns-resize; user-select: none; }
        .console-actions i { cursor: pointer; margin-left: 10px; color: #888; }
        .console-actions i:hover { color: white; }
        
        #console-output { flex: 1; padding: 10px; font-family: 'Consolas', monospace; font-size: 12px; overflow-y: auto; white-space: pre-wrap; color: #ccc; }
        .log-stdout { color: #ccc; }
        .log-stderr { color: var(--error); }
        .log-info { color: #4facfe; }

        /* Loader */
        .loader { border: 2px solid #f3f3f3; border-top: 2px solid var(--accent); border-radius: 50%; width: 12px; height: 12px; animation: spin 1s linear infinite; display: inline-block; margin-right: 5px; }
        @keyframes spin { 0% { transform: rotate(0deg); } 100% { transform: rotate(360deg); } }

    </style>
    
    <!-- Libraries -->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/marked/4.3.0/marked.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/require.js/2.3.6/require.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/monaco-editor/0.34.1/min/vs/loader.min.js"></script>
</head>
<body>

<div id="sidebar">
    <div class="header">
        <span><i class="fas fa-robot"></i> Gabriel's Forge</span>
        <span id="status" class="status-dot" title="Desconectado"></span>
    </div>
    
    <div class="config-area">
        <div class="input-group">
            <input type="text" id="apiUrl" placeholder="Link do T칰nel (ngrok/localtunnel)..." value="">
            <button class="icon-btn" title="Salvar URL" onclick="saveConfig()"><i class="fas fa-save"></i></button>
        </div>
    </div>
    
    <div id="chat-history">
        <div class="message bot">
            Ol치, Gabriel! 游<br>
            Estou pronto. Conecte ao t칰nel do Colab e vamos codar.
            <br><br>
            <i>Experimente: "Crie um script para detectar rostos"</i>
        </div>
    </div>
    
    <div class="input-area">
        <textarea id="userInput" placeholder="Digite sua instru칞칚o... (Ctrl+Enter para enviar)"></textarea>
        <button id="sendBtn" onclick="sendMessage()">
            <i class="fas fa-paper-plane"></i> Enviar Instru칞칚o
        </button>
    </div>
</div>

<div id="main-content">
    <div class="editor-toolbar">
        <div class="toolbar-group">
            <i class="fas fa-file-code" style="color: #4facfe;"></i>
            <span class="filename">script.py</span>
        </div>
        <div class="toolbar-group">
            <button class="run-btn" id="runBtn" onclick="runCode()">
                <i class="fas fa-play"></i> Rodar C칩digo
            </button>
        </div>
    </div>
    
    <div id="editor-wrapper">
        <div id="monaco-container"></div>
        
        <div id="console-panel">
            <div class="console-header" onmousedown="startResize(event)">
                <span>Terminal de Sa칤da</span>
                <div class="console-actions">
                    <i class="fas fa-eraser" title="Limpar" onclick="clearConsole()"></i>
                    <i class="fas fa-chevron-down" title="Minimizar" onclick="toggleConsole()"></i>
                </div>
            </div>
            <div id="console-output">
                <div class="log-info">[Sistema] Console pronto. Execute seu c칩digo para ver a sa칤da aqui.</div>
            </div>
        </div>
    </div>
</div>

<script>
    // --- Configuration & Initialization ---
    let editor;
    const defaultCode = "# Escreva ou gere seu c칩digo Python aqui...\n\nimport sys\n\nprint('Ol치 do Colab!')\nprint(f'Python Version: {sys.version}')";

    // Load URL from local storage
    window.onload = function() {
        const savedUrl = localStorage.getItem('tunnelUrl');
        if (savedUrl) {
            document.getElementById('apiUrl').value = savedUrl;
        }
    };

    function saveConfig() {
        const url = document.getElementById('apiUrl').value.trim();
        if (url) {
            localStorage.setItem('tunnelUrl', url);
            alert('URL do t칰nel salva!');
        }
    }

    // --- Monaco Editor Setup ---
    require.config({ paths: { 'vs': 'https://cdnjs.cloudflare.com/ajax/libs/monaco-editor/0.34.1/min/vs' }});
    require(['vs/editor/editor.main'], function() {
        editor = monaco.editor.create(document.getElementById('monaco-container'), {
            value: defaultCode,
            language: 'python',
            theme: 'vs-dark',
            automaticLayout: true,
            fontSize: 14,
            minimap: { enabled: false },
            scrollBeyondLastLine: false
        });

        // Shortcuts
        editor.addCommand(monaco.KeyMod.CtrlCmd | monaco.KeyCode.Enter, function() {
            runCode();
        });
    });

    // --- Chat Logic ---
    async function sendMessage() {
        const input = document.getElementById('userInput');
        const btn = document.getElementById('sendBtn');
        const urlField = document.getElementById('apiUrl');
        const statusDot = document.getElementById('status');
        
        const message = input.value.trim();
        let baseUrl = urlField.value.trim().replace(/\/$/, "");
        
        if (!message) return;
        if (!baseUrl) { alert("Por favor, cole o link do t칰nel!"); return; }

        // Save URL automatically on send
        localStorage.setItem('tunnelUrl', baseUrl);

        appendMessage('user', message);
        input.value = '';
        
        // Loading State
        btn.disabled = true;
        btn.innerHTML = '<div class="loader"></div> Pensando...';
        
        const currentCode = editor ? editor.getValue() : "";

        try {
            const response = await fetch(baseUrl + "/chat", {
                method: 'POST',
                headers: { 
                    'Content-Type': 'application/json',
                    'Bypass-Tunnel-Reminder': 'true',
                    'ngrok-skip-browser-warning': 'true'
                },
                body: JSON.stringify({
                    message: message,
                    current_file_content: currentCode
                })
            });

            if (!response.ok) throw new Error(`HTTP ${response.status}`);

            const data = await response.json();
            
            // Update Status
            statusDot.className = "status-dot status-online";
            statusDot.title = "Online";
            
            if (data.response) {
                appendBotMessage(data.response);
            } else {
                appendBotMessage("Recebi uma resposta vazia do servidor.");
            }

        } catch (error) {
            console.error(error);
            statusDot.className = "status-dot";
            statusDot.title = "Offline";
            appendBotMessage(`**Erro de Conex칚o:** N칚o foi poss칤vel falar com o agente.\nVerify se a URL do t칰nel est치 correta.\n\n*Detalhes: ${error.message}*`);
        } finally {
            btn.disabled = false;
            btn.innerHTML = '<i class="fas fa-paper-plane"></i> Enviar Instru칞칚o';
        }
    }

    function appendMessage(role, text) {
        const history = document.getElementById('chat-history');
        const div = document.createElement('div');
        div.className = `message ${role}`;
        
        if (role === 'user') {
            div.innerText = text;
        }
        
        history.appendChild(div);
        history.scrollTop = history.scrollHeight;
    }

    function appendBotMessage(markdownText) {
        const history = document.getElementById('chat-history');
        const div = document.createElement('div');
        div.className = 'message bot';
        
        // Parse Markdown using marked.js
        let htmlContent = marked.parse(markdownText);
        
        // Add Apply Buttons to code blocks
        // We do a simple regex replace on the generated HTML to inject buttons before <pre> tags
        // This is a bit hacky but works for simple cases without a custom renderer
        const tempDiv = document.createElement('div');
        tempDiv.innerHTML = htmlContent;
        
        const preTags = tempDiv.querySelectorAll('pre');
        preTags.forEach(pre => {
            const code = pre.innerText;
            const btn = document.createElement('button');
            btn.className = 'apply-btn';
            btn.innerHTML = '<i class="fas fa-magic"></i> Aplicar no Editor';
            btn.onclick = function() { applyCode(code); };
            
            // Wrapper to hold button + code
            const wrapper = document.createElement('div');
            wrapper.style.position = 'relative';
            
            pre.parentNode.insertBefore(wrapper, pre);
            wrapper.appendChild(btn);
            wrapper.appendChild(pre);
        });
        
        div.innerHTML = tempDiv.innerHTML;
        
        history.appendChild(div);
        history.scrollTop = history.scrollHeight;
    }

    function applyCode(code) {
        if(editor) {
            editor.setValue(code);
            logConsole("C칩digo aplicado ao editor.", "info");
        }
    }

    // --- Execution Logic ---
    async function runCode() {
        const btn = document.getElementById('runBtn');
        const urlField = document.getElementById('apiUrl');
        const baseUrl = urlField.value.trim().replace(/\/$/, "");
        
        if (!baseUrl) { alert("Configure a URL do t칰nel primeiro!"); return; }
        
        const code = editor.getValue();
        
        btn.disabled = true;
        btn.innerHTML = '<div class="loader"></div> Rodando...';
        logConsole("Executando script...", "info");
        
        try {
            const response = await fetch(baseUrl + "/run", {
                method: 'POST',
                headers: { 
                    'Content-Type': 'application/json',
                    'Bypass-Tunnel-Reminder': 'true',
                    'ngrok-skip-browser-warning': 'true'
                },
                body: JSON.stringify({ code: code })
            });
            
            if (!response.ok) throw new Error(`HTTP ${response.status}`);
            
            const data = await response.json();
            
            if (data.returncode === 0) {
                if (data.stdout) logConsole(data.stdout, "stdout");
                else logConsole("[Processo finalizado sem sa칤da]", "info");
            } else {
                if (data.stdout) logConsole(data.stdout, "stdout");
                if (data.stderr) logConsole(data.stderr, "stderr");
                logConsole(`Processo saiu com c칩digo ${data.returncode}`, "info");
            }
            
        } catch (error) {
            logConsole(`Erro ao executar: ${error.message}`, "stderr");
        } finally {
            btn.disabled = false;
            btn.innerHTML = '<i class="fas fa-play"></i> Rodar C칩digo';
        }
    }

    // --- Console Logic ---
    function logConsole(text, type) {
        const output = document.getElementById('console-output');
        const entry = document.createElement('div');
        entry.className = `log-${type}`;
        entry.innerText = text; // Securely set text
        output.appendChild(entry);
        output.scrollTop = output.scrollHeight;
    }

    function clearConsole() {
        document.getElementById('console-output').innerHTML = '';
        logConsole("[Console Limpo]", "info");
    }

    function toggleConsole() {
        const panel = document.getElementById('console-panel');
        if (panel.style.height === '30px') {
            panel.style.height = '150px';
        } else {
            panel.style.height = '30px';
        }
    }

    // Simple Resize Logic (Vertical)
    let isResizing = false;
    let lastY = 0;
    
    function startResize(e) {
        isResizing = true;
        lastY = e.clientY;
        document.addEventListener('mousemove', handleResize);
        document.addEventListener('mouseup', stopResize);
    }
    
    function handleResize(e) {
        if (!isResizing) return;
        const panel = document.getElementById('console-panel');
        const delta = lastY - e.clientY;
        const newHeight = parseInt(getComputedStyle(panel).height) + delta;
        
        if (newHeight > 30 && newHeight < 600) {
            panel.style.height = newHeight + 'px';
            lastY = e.clientY;
            if(editor) editor.layout();
        }
    }
    
    function stopResize() {
        isResizing = false;
        document.removeEventListener('mousemove', handleResize);
        document.removeEventListener('mouseup', stopResize);
        if(editor) editor.layout();
    }
    
    // Ctrl+Enter in Input
    document.getElementById('userInput').addEventListener('keydown', function(e) {
        if (e.ctrlKey && e.key === 'Enter') sendMessage();
    });

</script>

</body>
</html>
